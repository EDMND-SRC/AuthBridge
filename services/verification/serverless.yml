service: authbridge-verification

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  region: af-south-1
  stage: ${opt:stage, 'staging'}
  memorySize: 512
  timeout: 30
  apiGateway:
    minimumCompressionSize: 1024
    shouldStartNameWithService: true
  # IMPORTANT: Endpoint type must match existing API Gateway
  # staging: EDGE (already deployed as EDGE)
  # production: REGIONAL (for af-south-1 data residency)
  endpointType: ${self:custom.endpointTypes.${self:provider.stage}, 'EDGE'}
  environment:
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
    NODE_OPTIONS: '--enable-source-maps'
    TABLE_NAME: AuthBridgeTable
    BUCKET_NAME: authbridge-documents-${self:provider.stage}
    # Use stage-aware CloudFormation references
    DATA_ENCRYPTION_KEY_ID: ${cf:authbridge-kms-${self:provider.stage}.DataEncryptionKeyId}
    DATA_ENCRYPTION_KEY_ARN: ${cf:authbridge-kms-${self:provider.stage}.DataEncryptionKeyArn}

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:Query
          Resource:
            - 'arn:aws:dynamodb:${self:provider.region}:*:table/AuthBridgeTable'
            - 'arn:aws:dynamodb:${self:provider.region}:*:table/AuthBridgeTable/index/*'
        # Audit log immutability: Allow PutItem for audit logs, deny Update/Delete
        - Effect: Allow
          Action:
            - dynamodb:PutItem
          Resource:
            - 'arn:aws:dynamodb:${self:provider.region}:*:table/AuthBridgeTable'
          Condition:
            StringLike:
              'dynamodb:LeadingKeys':
                - 'AUDIT#*'
        - Effect: Deny
          Action:
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - 'arn:aws:dynamodb:${self:provider.region}:*:table/AuthBridgeTable'
          Condition:
            StringLike:
              'dynamodb:LeadingKeys':
                - 'AUDIT#*'
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
          Resource:
            - 'arn:aws:s3:::authbridge-documents-${self:provider.stage}/*'
        - Effect: Allow
          Action:
            - textract:DetectDocumentText
          Resource: '*'
        - Effect: Allow
          Action:
            - rekognition:CompareFaces
            - rekognition:DetectFaces
            - rekognition:GetFaceLivenessSessionResults
          Resource: '*'
        - Effect: Allow
          Action:
            - cloudwatch:PutMetricData
          Resource: '*'
        - Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:GetQueueUrl
          Resource:
            - !GetAtt OcrQueue.Arn
            - !GetAtt BiometricQueue.Arn
            - !GetAtt WebhookQueue.Arn
        - Effect: Allow
          Action:
            - sns:Publish
          Resource:
            - !Ref OcrAlertTopic
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: 'arn:aws:logs:${self:provider.region}:*:*'
        - Effect: Allow
          Action:
            - kms:Encrypt
            - kms:Decrypt
            - kms:GenerateDataKey
            - kms:GenerateDataKeyWithoutPlaintext
            - kms:DescribeKey
          Resource:
            - ${cf:authbridge-kms-${self:provider.stage}.DataEncryptionKeyArn}
        # Audit log encryption with dedicated KMS key
        - Effect: Allow
          Action:
            - kms:Decrypt
            - kms:GenerateDataKey
          Resource:
            - ${cf:authbridge-kms-${self:provider.stage}.AuditLogEncryptionKeyArn}

# esbuild handles packaging - minimal exclusions needed
package:
  individually: true
  patterns:
    - '!**'
    - '!node_modules/**'
    - '!src/**'
    - '!tests/**'
    - '!test-data/**'
    - '!docs/**'
    - '!scripts/**'
    - '!*.md'
    - '!*.config.ts'
    - '!*.config.js'
    - '!tsconfig*.json'

functions:
  listCases:
    handler: src/handlers/list-cases.handler
    description: List verification cases with filtering and pagination
    events:
      - http:
          path: /api/v1/cases
          method: get
          cors: true

  getCase:
    handler: src/handlers/get-case.handler
    description: Get case detail by ID
    events:
      - http:
          path: /api/v1/cases/{id}
          method: get
          cors: true

  approveCase:
    handler: src/handlers/approve-case.handler
    description: Approve a verification case
    environment:
      WEBHOOK_QUEUE_URL: !Ref WebhookQueue
    events:
      - http:
          path: /api/v1/cases/{id}/approve
          method: post
          cors: true

  rejectCase:
    handler: src/handlers/reject-case.handler
    description: Reject a verification case with reason
    environment:
      WEBHOOK_QUEUE_URL: !Ref WebhookQueue
    events:
      - http:
          path: /api/v1/cases/{id}/reject
          method: post
          cors: true

  sendWebhook:
    handler: src/handlers/send-webhook.handler
    description: Send webhook notifications for case decisions
    memorySize: 256
    timeout: 30
    environment:
      WEBHOOK_QUEUE_URL: !Ref WebhookQueue
    events:
      - sqs:
          arn: !GetAtt WebhookQueue.Arn
          batchSize: 10

  configureWebhook:
    handler: src/handlers/configure-webhook.handler
    description: Configure webhook URL and settings for client
    memorySize: 256
    timeout: 10
    events:
      - http:
          path: /api/v1/webhooks/configure
          method: post
          cors: true
          authorizer:
            name: apiKeyAuthorizer
            arn: arn:aws:lambda:${self:provider.region}:${aws:accountId}:function:authbridge-auth-${self:provider.stage}-apiKeyAuthorizer
            type: request
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 300

  testWebhook:
    handler: src/handlers/test-webhook.handler
    description: Send test webhook notification to verify configuration
    memorySize: 256
    timeout: 30
    events:
      - http:
          path: /api/v1/webhooks/test
          method: post
          cors: true
          authorizer:
            name: apiKeyAuthorizer
            arn: arn:aws:lambda:${self:provider.region}:${aws:accountId}:function:authbridge-auth-${self:provider.stage}-apiKeyAuthorizer
            type: request
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 300

  addNote:
    handler: src/handlers/add-note.handler
    description: Add note to case
    events:
      - http:
          path: /api/v1/cases/{id}/notes
          method: post
          cors: true

  getNotes:
    handler: src/handlers/get-notes.handler
    description: Get all notes for a case
    events:
      - http:
          path: /api/v1/cases/{id}/notes
          method: get
          cors: true

  getAuditLogs:
    handler: src/handlers/get-audit-logs.getAuditLogs
    description: Query audit logs with filters (date, user, action, resource)
    events:
      - http:
          path: /api/v1/audit
          method: get
          cors: true

  bulkApprove:
    handler: src/handlers/bulk-approve.handler
    description: Bulk approve multiple verification cases
    memorySize: 512
    timeout: 30
    environment:
      WEBHOOK_QUEUE_URL: !Ref WebhookQueue
    events:
      - http:
          path: /api/v1/cases/bulk-approve
          method: post
          cors: true

  bulkReject:
    handler: src/handlers/bulk-reject.handler
    description: Bulk reject multiple verification cases with reason
    memorySize: 512
    timeout: 30
    environment:
      WEBHOOK_QUEUE_URL: !Ref WebhookQueue
    events:
      - http:
          path: /api/v1/cases/bulk-reject
          method: post
          cors: true

  createVerification:
    handler: src/handlers/create-verification.handler
    description: Create new verification case
    environment:
      JWT_SECRET: ${env:JWT_SECRET, 'staging-jwt-secret-change-in-production'}
      JWT_ISSUER: ${env:JWT_ISSUER, 'authbridge'}
      SESSION_TOKEN_EXPIRY_HOURS: ${env:SESSION_TOKEN_EXPIRY_HOURS, '0.5'}
      SDK_BASE_URL: ${env:SDK_BASE_URL, 'https://sdk.authbridge.io'}
    events:
      - http:
          path: /api/v1/verifications
          method: post
          cors: true
          authorizer:
            name: apiKeyAuthorizer
            arn: arn:aws:lambda:${self:provider.region}:${aws:accountId}:function:authbridge-auth-${self:provider.stage}-apiKeyAuthorizer
            type: request
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 300

  getVerificationStatus:
    handler: src/handlers/get-verification-status.handler
    description: Get verification status and details
    memorySize: 512
    timeout: 10
    events:
      - http:
          path: /api/v1/verifications/{verificationId}
          method: get
          cors: true
          authorizer:
            name: apiKeyAuthorizer
            arn: arn:aws:lambda:${self:provider.region}:${aws:accountId}:function:authbridge-auth-${self:provider.stage}-apiKeyAuthorizer
            type: request
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 300

  uploadDocument:
    handler: src/handlers/upload-document.handler
    description: Upload document to verification case
    memorySize: 1024
    timeout: 30
    environment:
      OCR_QUEUE_URL: !Ref OcrQueue
    events:
      - http:
          path: /api/v1/verifications/{verificationId}/documents
          method: post
          cors: true
          authorizer:
            name: apiKeyAuthorizer
            arn: arn:aws:lambda:${self:provider.region}:${aws:accountId}:function:authbridge-auth-${self:provider.stage}-apiKeyAuthorizer
            type: request
            identitySource: method.request.header.Authorization
            resultTtlInSeconds: 300

  refreshDocumentUrl:
    handler: src/handlers/refresh-document-url.handler
    description: Refresh presigned URL for document access
    events:
      - http:
          path: /api/v1/verifications/{verificationId}/documents/{documentId}/url
          method: post
          cors: true

  processOCR:
    handler: src/handlers/process-ocr.handler
    description: Process OCR extraction from document images
    memorySize: 512
    timeout: 60
    environment:
      OCR_ALERT_TOPIC_ARN: !Ref OcrAlertTopic
      BIOMETRIC_QUEUE_URL: !Ref BiometricQueue
    events:
      - sqs:
          arn: !GetAtt OcrQueue.Arn
          batchSize: 1
          functionResponseType: ReportBatchItemFailures

  processBiometric:
    handler: src/handlers/process-biometric.handler
    description: Process biometric face matching (liveness + comparison)
    memorySize: 1024
    timeout: 60
    environment:
      BIOMETRIC_QUEUE_URL: !Ref BiometricQueue
    events:
      - sqs:
          arn: !GetAtt BiometricQueue.Arn
          batchSize: 1
          functionResponseType: ReportBatchItemFailures

resources:
  Resources:
    DocumentsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: authbridge-documents-${self:provider.stage}
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: aws:kms
                KMSMasterKeyID: ${cf:authbridge-kms-${self:provider.stage}.DataEncryptionKeyArn}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true

    DocumentsBucketPolicy:
      Type: AWS::S3::BucketPolicy
      Properties:
        Bucket: !Ref DocumentsBucket
        PolicyDocument:
          Statement:
            - Sid: DenyUnencryptedObjectUploads
              Effect: Deny
              Principal: '*'
              Action: s3:PutObject
              Resource: !Sub '${DocumentsBucket.Arn}/*'
              Condition:
                StringNotEquals:
                  's3:x-amz-server-side-encryption': 'aws:kms'
            - Sid: DenyIncorrectEncryptionHeader
              Effect: Deny
              Principal: '*'
              Action: s3:PutObject
              Resource: !Sub '${DocumentsBucket.Arn}/*'
              Condition:
                StringNotEqualsIfExists:
                  's3:x-amz-server-side-encryption-aws-kms-key-id': ${cf:authbridge-kms-${self:provider.stage}.DataEncryptionKeyArn}

    OcrQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: authbridge-ocr-queue-${self:provider.stage}
        VisibilityTimeout: 360
        MessageRetentionPeriod: 345600
        ReceiveMessageWaitTimeSeconds: 0
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt OcrDLQ.Arn
          maxReceiveCount: 3

    OcrDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: authbridge-ocr-dlq-${self:provider.stage}
        MessageRetentionPeriod: 1209600
        ReceiveMessageWaitTimeSeconds: 0

    BiometricQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: authbridge-biometric-queue-${self:provider.stage}
        VisibilityTimeout: 360
        MessageRetentionPeriod: 345600
        ReceiveMessageWaitTimeSeconds: 0
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt BiometricDLQ.Arn
          maxReceiveCount: 3

    BiometricDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: authbridge-biometric-dlq-${self:provider.stage}
        MessageRetentionPeriod: 1209600
        ReceiveMessageWaitTimeSeconds: 0

    WebhookQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: authbridge-webhook-queue-${self:provider.stage}
        VisibilityTimeout: 90
        MessageRetentionPeriod: 86400
        ReceiveMessageWaitTimeSeconds: 0
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt WebhookDLQ.Arn
          maxReceiveCount: 3

    WebhookDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: authbridge-webhook-dlq-${self:provider.stage}
        MessageRetentionPeriod: 1209600
        ReceiveMessageWaitTimeSeconds: 0

    OcrAlertTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: authbridge-ocr-alerts-${self:provider.stage}
        DisplayName: AuthBridge OCR Alerts

    # Audit Log Group with 5-year retention for DPA 2024 compliance
    AuditLogGroup:
      Type: AWS::Logs::LogGroup
      Properties:
        LogGroupName: /aws/lambda/authbridge-verification-${self:provider.stage}/audit
        RetentionInDays: 1827  # Closest valid value to 5 years (1825 days)
        KmsKeyId: ${cf:authbridge-kms-${self:provider.stage}.AuditLogEncryptionKeyArn}

    # Audit Monitoring Alarms
    AuditLogWriteFailureAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-audit-write-failure-${self:provider.stage}
        AlarmDescription: Audit log write failures detected
        MetricName: AuditWriteFailures
        Namespace: AuthBridge/Audit
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 1
        Threshold: 10
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    AuditLogVolumeAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-audit-volume-spike-${self:provider.stage}
        AlarmDescription: Audit log volume spike detected (potential attack or system issue)
        MetricName: AuditLogEntries
        Namespace: AuthBridge/Audit
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 2
        Threshold: 10000
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic


    # CloudWatch Alarms for OCR monitoring
    OcrSuccessRateAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-ocr-success-rate-${self:provider.stage}
        AlarmDescription: OCR success rate below 85%
        MetricName: OcrSuccess
        Namespace: AuthBridge/Verification
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 3
        Threshold: 85
        ComparisonOperator: LessThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    OcrConfidenceAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-ocr-confidence-${self:provider.stage}
        AlarmDescription: Average OCR confidence below 90%
        MetricName: OcrConfidenceScore
        Namespace: AuthBridge/Verification
        Statistic: Average
        Period: 300
        EvaluationPeriods: 3
        Threshold: 90
        ComparisonOperator: LessThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    OcrProcessingTimeAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-ocr-processing-time-${self:provider.stage}
        AlarmDescription: OCR processing time exceeds 10 seconds (p95)
        MetricName: OcrProcessingTime
        Namespace: AuthBridge/Verification
        ExtendedStatistic: p95
        Period: 300
        EvaluationPeriods: 2
        Threshold: 10000
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    OcrDLQAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-ocr-dlq-messages-${self:provider.stage}
        AlarmDescription: Messages in OCR Dead Letter Queue
        MetricName: ApproximateNumberOfMessagesVisible
        Namespace: AWS/SQS
        Dimensions:
          - Name: QueueName
            Value: !GetAtt OcrDLQ.QueueName
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 1
        Threshold: 1
        ComparisonOperator: GreaterThanOrEqualToThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    BiometricPassRateAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-biometric-pass-rate-${self:provider.stage}
        AlarmDescription: Biometric pass rate below 70%
        MetricName: BiometricPassed
        Namespace: AuthBridge/Verification
        Statistic: Sum
        Period: 3600
        EvaluationPeriods: 1
        Threshold: 70
        ComparisonOperator: LessThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    BiometricDLQAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-biometric-dlq-messages-${self:provider.stage}
        AlarmDescription: Messages in Biometric Dead Letter Queue
        MetricName: ApproximateNumberOfMessagesVisible
        Namespace: AWS/SQS
        Dimensions:
          - Name: QueueName
            Value: !GetAtt BiometricDLQ.QueueName
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 1
        Threshold: 1
        ComparisonOperator: GreaterThanOrEqualToThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

  Outputs:
    OcrAlertTopicArn:
      Description: ARN of the OCR Alert SNS Topic
      Value: !Ref OcrAlertTopic
      Export:
        Name: authbridge-ocr-alert-topic-${self:provider.stage}

plugins:
  - serverless-esbuild
  - serverless-offline

custom:
  # Stage-specific endpoint types
  # IMPORTANT: These must match existing API Gateway configurations
  # Changing endpoint type on existing API Gateway causes deployment failures
  endpointTypes:
    staging: EDGE      # Already deployed as EDGE
    production: REGIONAL  # For af-south-1 data residency compliance

  esbuild:
    bundle: true
    minify: true
    sourcemap: false
    exclude:
      # AWS SDK v3 is available in Lambda runtime - don't bundle
      - '@aws-sdk/*'
      - '@smithy/*'
    target: node20
    platform: node
    concurrency: 10
    packager: pnpm
    treeShaking: true
    keepNames: true

  serverless-offline:
    httpPort: 3002
