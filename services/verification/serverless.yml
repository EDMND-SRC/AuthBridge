service: authbridge-verification

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  region: af-south-1
  stage: ${opt:stage, 'staging'}
  memorySize: 512
  timeout: 30
  environment:
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
    NODE_OPTIONS: '--enable-source-maps'
    TABLE_NAME: AuthBridgeTable
    BUCKET_NAME: authbridge-documents-${self:provider.stage}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:Query
          Resource:
            - 'arn:aws:dynamodb:${self:provider.region}:*:table/AuthBridgeTable'
            - 'arn:aws:dynamodb:${self:provider.region}:*:table/AuthBridgeTable/index/*'
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
          Resource:
            - 'arn:aws:s3:::authbridge-documents-${self:provider.stage}/*'
        - Effect: Allow
          Action:
            - textract:DetectDocumentText
          Resource: '*'
        - Effect: Allow
          Action:
            - rekognition:CompareFaces
            - rekognition:DetectFaces
            - rekognition:GetFaceLivenessSessionResults
          Resource: '*'
        - Effect: Allow
          Action:
            - cloudwatch:PutMetricData
          Resource: '*'
        - Effect: Allow
          Action:
            - sqs:SendMessage
            - sqs:GetQueueUrl
          Resource:
            - !GetAtt OcrQueue.Arn
            - !GetAtt BiometricQueue.Arn
        - Effect: Allow
          Action:
            - sns:Publish
          Resource:
            - !Ref OcrAlertTopic
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: 'arn:aws:logs:${self:provider.region}:*:*'

functions:
  createVerification:
    handler: dist/handlers/create-verification.handler
    description: Create new verification case
    events:
      - http:
          path: /api/v1/verifications
          method: post
          cors: true

  getVerification:
    handler: dist/handlers/get-verification.handler
    description: Get verification case by ID
    events:
      - http:
          path: /api/v1/verifications/{verificationId}
          method: get
          cors: true

  uploadDocument:
    handler: dist/handlers/upload-document.handler
    description: Upload document to verification case
    memorySize: 1024
    timeout: 30
    environment:
      OCR_QUEUE_URL: !Ref OcrQueue
    events:
      - http:
          path: /api/v1/verifications/{verificationId}/documents
          method: post
          cors: true

  refreshDocumentUrl:
    handler: dist/handlers/refresh-document-url.handler
    description: Refresh presigned URL for document access
    events:
      - http:
          path: /api/v1/verifications/{verificationId}/documents/{documentId}/url
          method: post
          cors: true

  processOCR:
    handler: dist/handlers/process-ocr.handler
    description: Process OCR extraction from document images
    memorySize: 512
    timeout: 60
    reservedConcurrency: 1  # Respect 1 TPS Textract quota in af-south-1
    environment:
      OCR_ALERT_TOPIC_ARN: !Ref OcrAlertTopic
      BIOMETRIC_QUEUE_URL: !Ref BiometricQueue
    events:
      - sqs:
          arn: !GetAtt OcrQueue.Arn
          batchSize: 1  # Process one document at a time due to 1 TPS limit
          maximumBatchingWindowInSeconds: 0
          functionResponseType: ReportBatchItemFailures

  processBiometric:
    handler: dist/handlers/process-biometric.handler
    description: Process biometric face matching (liveness + comparison)
    memorySize: 1024
    timeout: 60
    reservedConcurrency: 5  # Respect 5 TPS Rekognition quota in af-south-1
    environment:
      BIOMETRIC_QUEUE_URL: !Ref BiometricQueue
    events:
      - sqs:
          arn: !GetAtt BiometricQueue.Arn
          batchSize: 1  # Process one verification at a time
          maximumBatchingWindowInSeconds: 0
          functionResponseType: ReportBatchItemFailures

resources:
  Resources:
    DocumentsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: authbridge-documents-${self:provider.stage}
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true

    OcrQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: authbridge-ocr-queue-${self:provider.stage}
        VisibilityTimeout: 360  # 6 minutes (Lambda timeout 60s + buffer)
        MessageRetentionPeriod: 345600  # 4 days
        ReceiveMessageWaitTimeSeconds: 0
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt OcrDLQ.Arn
          maxReceiveCount: 3

    OcrDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: authbridge-ocr-dlq-${self:provider.stage}
        MessageRetentionPeriod: 1209600  # 14 days
        ReceiveMessageWaitTimeSeconds: 0

    BiometricQueue:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: authbridge-biometric-queue-${self:provider.stage}
        VisibilityTimeout: 360  # 6 minutes (Lambda timeout 60s + buffer)
        MessageRetentionPeriod: 345600  # 4 days
        ReceiveMessageWaitTimeSeconds: 0
        RedrivePolicy:
          deadLetterTargetArn: !GetAtt BiometricDLQ.Arn
          maxReceiveCount: 3

    BiometricDLQ:
      Type: AWS::SQS::Queue
      Properties:
        QueueName: authbridge-biometric-dlq-${self:provider.stage}
        MessageRetentionPeriod: 1209600  # 14 days
        ReceiveMessageWaitTimeSeconds: 0

    # SNS Topic for OCR failure alerts
    OcrAlertTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: authbridge-ocr-alerts-${self:provider.stage}
        DisplayName: AuthBridge OCR Alerts

    # CloudWatch Alarms for OCR monitoring
    OcrSuccessRateAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-ocr-success-rate-${self:provider.stage}
        AlarmDescription: OCR success rate below 85%
        MetricName: OcrSuccess
        Namespace: AuthBridge/Verification
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 3
        Threshold: 85
        ComparisonOperator: LessThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    OcrConfidenceAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-ocr-confidence-${self:provider.stage}
        AlarmDescription: Average OCR confidence below 90%
        MetricName: OcrConfidenceScore
        Namespace: AuthBridge/Verification
        Statistic: Average
        Period: 300
        EvaluationPeriods: 3
        Threshold: 90
        ComparisonOperator: LessThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    OcrProcessingTimeAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-ocr-processing-time-${self:provider.stage}
        AlarmDescription: OCR processing time exceeds 10 seconds (p95)
        MetricName: OcrProcessingTime
        Namespace: AuthBridge/Verification
        ExtendedStatistic: p95
        Period: 300
        EvaluationPeriods: 2
        Threshold: 10000
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    OcrManualReviewRateAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-ocr-manual-review-rate-${self:provider.stage}
        AlarmDescription: Manual review rate exceeds 30%
        MetricName: OcrManualReviewRequired
        Namespace: AuthBridge/Verification
        Statistic: Sum
        Period: 3600
        EvaluationPeriods: 1
        Threshold: 30
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    OcrDLQAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-ocr-dlq-messages-${self:provider.stage}
        AlarmDescription: Messages in OCR Dead Letter Queue
        MetricName: ApproximateNumberOfMessagesVisible
        Namespace: AWS/SQS
        Dimensions:
          - Name: QueueName
            Value: !GetAtt OcrDLQ.QueueName
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 1
        Threshold: 1
        ComparisonOperator: GreaterThanOrEqualToThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    # CloudWatch Alarms for Biometric monitoring
    BiometricPassRateAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-biometric-pass-rate-${self:provider.stage}
        AlarmDescription: Biometric pass rate below 70%
        MetricName: BiometricPassed
        Namespace: AuthBridge/Verification
        Statistic: Sum
        Period: 3600
        EvaluationPeriods: 1
        Threshold: 70
        ComparisonOperator: LessThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    BiometricSimilarityAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-biometric-similarity-${self:provider.stage}
        AlarmDescription: Average biometric similarity score below 85%
        MetricName: BiometricSimilarityScore
        Namespace: AuthBridge/Verification
        Statistic: Average
        Period: 300
        EvaluationPeriods: 3
        Threshold: 85
        ComparisonOperator: LessThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    BiometricProcessingTimeAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-biometric-processing-time-${self:provider.stage}
        AlarmDescription: Biometric processing time exceeds 5 seconds (p95)
        MetricName: BiometricProcessingTime
        Namespace: AuthBridge/Verification
        ExtendedStatistic: p95
        Period: 300
        EvaluationPeriods: 2
        Threshold: 5000
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    BiometricManualReviewRateAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-biometric-manual-review-rate-${self:provider.stage}
        AlarmDescription: Biometric manual review rate exceeds 40%
        MetricName: BiometricManualReviewRequired
        Namespace: AuthBridge/Verification
        Statistic: Sum
        Period: 3600
        EvaluationPeriods: 1
        Threshold: 40
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    BiometricFaceDetectionIssueAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-biometric-face-detection-issues-${self:provider.stage}
        AlarmDescription: Face detection issue rate exceeds 15%
        MetricName: FaceDetectionIssue
        Namespace: AuthBridge/Verification
        Statistic: Sum
        Period: 3600
        EvaluationPeriods: 1
        Threshold: 15
        ComparisonOperator: GreaterThanThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

    BiometricDLQAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: authbridge-biometric-dlq-messages-${self:provider.stage}
        AlarmDescription: Messages in Biometric Dead Letter Queue
        MetricName: ApproximateNumberOfMessagesVisible
        Namespace: AWS/SQS
        Dimensions:
          - Name: QueueName
            Value: !GetAtt BiometricDLQ.QueueName
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 1
        Threshold: 1
        ComparisonOperator: GreaterThanOrEqualToThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - !Ref OcrAlertTopic

  Outputs:
    OcrAlertTopicArn:
      Description: ARN of the OCR Alert SNS Topic
      Value: !Ref OcrAlertTopic
      Export:
        Name: authbridge-ocr-alert-topic-${self:provider.stage}

plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3002
