service: authbridge-auth

frameworkVersion: '3'

provider:
  name: aws
  runtime: nodejs20.x
  region: af-south-1
  stage: ${opt:stage, 'staging'}
  memorySize: 512
  timeout: 30
  environment:
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: '1'
    NODE_OPTIONS: '--enable-source-maps'
    COGNITO_USER_POOL_ID: ${env:COGNITO_USER_POOL_ID, 'placeholder-staging'}
    COGNITO_CLIENT_ID: ${env:COGNITO_CLIENT_ID, 'placeholder-staging'}
    JWT_SECRET: ${env:JWT_SECRET, 'staging-jwt-secret-change-in-production'}
    TABLE_NAME: AuthBridgeTable
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - cognito-idp:AdminGetUser
            - cognito-idp:AdminInitiateAuth
            - cognito-idp:InitiateAuth
            - cognito-idp:RespondToAuthChallenge
            - cognito-idp:GetUser
            - cognito-idp:GlobalSignOut
            - cognito-idp:SignUp
            - cognito-idp:ConfirmSignUp
          Resource: 'arn:aws:cognito-idp:${self:provider.region}:*:userpool/*'
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:Query
            - dynamodb:Scan
          Resource:
            - 'arn:aws:dynamodb:${self:provider.region}:*:table/AuthBridgeTable'
            - 'arn:aws:dynamodb:${self:provider.region}:*:table/AuthBridgeTable/index/*'
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: 'arn:aws:logs:${self:provider.region}:*:*'

functions:
  authorizer:
    handler: dist/handlers/authorizer.handler
    description: JWT token validation Lambda authorizer

  apiKeyAuthorizer:
    handler: dist/handlers/api-key-authorizer.handler
    description: API key validation Lambda authorizer

  createSession:
    handler: dist/handlers/create-session.handler
    description: Create new verification session
    events:
      - http:
          path: /sessions
          method: post
          cors: true

  validateSession:
    handler: dist/handlers/validate-session.handler
    description: Validate existing session
    events:
      - http:
          path: /sessions/{sessionId}
          method: get
          cors: true
          authorizer:
            name: authorizer
            type: token

  createApiKey:
    handler: dist/handlers/create-api-key.handler
    description: Create new API key
    events:
      - http:
          path: /api/v1/api-keys
          method: post
          cors: true
          authorizer:
            name: authorizer
            type: token

  listApiKeys:
    handler: dist/handlers/list-api-keys.handler
    description: List all API keys for a client
    events:
      - http:
          path: /api/v1/api-keys
          method: get
          cors: true
          authorizer:
            name: authorizer
            type: token

  revokeApiKey:
    handler: dist/handlers/revoke-api-key.handler
    description: Revoke an API key
    events:
      - http:
          path: /api/v1/api-keys/{keyId}
          method: delete
          cors: true
          authorizer:
            name: authorizer
            type: token

  rotateApiKey:
    handler: dist/handlers/rotate-api-key.handler
    description: Rotate an API key
    events:
      - http:
          path: /api/v1/api-keys/{keyId}/rotate
          method: post
          cors: true
          authorizer:
            name: authorizer
            type: token

  # User Authentication Endpoints (Backoffice)
  userLogin:
    handler: dist/handlers/user-login.handler
    description: Initiate passwordless login (sends OTP)
    events:
      - http:
          path: /auth/login
          method: post
          cors: true

  userVerifyOtp:
    handler: dist/handlers/user-verify-otp.handler
    description: Verify OTP and complete authentication
    events:
      - http:
          path: /auth/verify-otp
          method: post
          cors: true

  userRefreshToken:
    handler: dist/handlers/user-refresh-token.handler
    description: Refresh access tokens
    events:
      - http:
          path: /auth/refresh
          method: post
          cors: true

  userLogout:
    handler: dist/handlers/user-logout.handler
    description: Sign out user globally
    events:
      - http:
          path: /auth/logout
          method: post
          cors: true

  userMe:
    handler: dist/handlers/user-me.handler
    description: Get current user information
    events:
      - http:
          path: /auth/me
          method: get
          cors: true

plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3001

# Commented out UsagePlan temporarily to fix deployment issue
# Will add back after initial deployment
# resources:
#   Resources:
#     # API Gateway Usage Plan with Throttling
#     ApiGatewayUsagePlan:
#       Type: AWS::ApiGateway::UsagePlan
#       Properties:
#         UsagePlanName: ${self:service}-${self:provider.stage}-usage-plan
#         Description: Rate limiting for AuthBridge API
#         Throttle:
#           BurstLimit: 100
#           RateLimit: 50
#         ApiStages:
#           - ApiId:
#               Ref: ApiGatewayRestApi
#             Stage: ${self:provider.stage}
